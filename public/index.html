<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roblox Rank Manager - Beyond UI Style</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div id="root" class="w-full max-w-3xl"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [mode, setMode] = useState('revert'); // revert or manual

      // --- Revert abuse state
      const [cookieRevert, setCookieRevert] = useState('');
      const [groupIdRevert, setGroupIdRevert] = useState('');
      const [ranksRevert, setRanksRevert] = useState([]);
      const [currentRankIdRevert, setCurrentRankIdRevert] = useState('');
      const [newRankIdRevert, setNewRankIdRevert] = useState('');
      const [logRevert, setLogRevert] = useState('Revert logs will appear here...');

      // --- Manual mode state
      const [cookieManual, setCookieManual] = useState('');
      const [groupIdManual, setGroupIdManual] = useState('');
      const [ranksManual, setRanksManual] = useState([]);
      const [usersManual, setUsersManual] = useState([]);
      const [filteredUsers, setFilteredUsers] = useState([]);
      const [searchUser, setSearchUser] = useState('');
      const [selectedUser, setSelectedUser] = useState(null);
      const [newRankManual, setNewRankManual] = useState('');
      const [logManual, setLogManual] = useState('Manual logs will appear here...');

      // Fetch ranks for revert mode
      async function fetchRanksRevert() {
        if (!groupIdRevert.trim()) {
          setLogRevert('âš ï¸ Enter Group ID first.');
          return;
        }
        setLogRevert('â³ Fetching ranks...');
        try {
          const res = await fetch(`/roles?groupId=${groupIdRevert.trim()}`);
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Invalid ranks data');
          setRanksRevert(data);
          setCurrentRankIdRevert('');
          setNewRankIdRevert('');
          setLogRevert('âœ… Ranks loaded!');
        } catch (e) {
          setLogRevert('ğŸ’€ Error fetching ranks: ' + e.message);
        }
      }

      // Start revert abuse
      async function startRevert() {
        setLogRevert('â³ Reverting ranks...');
        if (!cookieRevert || !groupIdRevert || !currentRankIdRevert || !newRankIdRevert) {
          setLogRevert('âš ï¸ Fill all fields correctly.');
          return;
        }
        try {
          const res = await fetch('/revert', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              cookie: cookieRevert,
              groupId: Number(groupIdRevert),
              currentRankId: Number(currentRankIdRevert),
              newRankId: Number(newRankIdRevert)
            }),
          });
          const data = await res.json();
          if (data.success) {
            setLogRevert(`âœ… Reverted ${data.count} users\n\n${(data.logs || []).join('\n')}`);
          } else {
            setLogRevert('âŒ Failed: ' + data.error);
          }
        } catch(e) {
          setLogRevert('ğŸ’¥ Could not contact backend: ' + e.message);
        }
      }

      // Fetch ranks & users for manual mode
      async function fetchUsersManual() {
        setLogManual('â³ Fetching users and ranks...');
        setUsersManual([]);
        setFilteredUsers([]);
        setSelectedUser(null);
        setNewRankManual('');
        if (!cookieManual || !groupIdManual) {
          setLogManual('âš ï¸ Fill in cookie and group ID first.');
          return;
        }
        try {
          // fetch ranks
          const ranksRes = await fetch(`/roles?groupId=${groupIdManual.trim()}`);
          const ranksData = await ranksRes.json();
          if (!Array.isArray(ranksData)) throw new Error('Invalid ranks data');
          setRanksManual(ranksData);
          setNewRankManual('');
          // fetch users
          const usersRes = await fetch(`/users?cookie=${encodeURIComponent(cookieManual)}&groupId=${groupIdManual.trim()}`);
          const usersData = await usersRes.json();
          if (!Array.isArray(usersData)) throw new Error('Invalid users data');
          setUsersManual(usersData);
          setFilteredUsers(usersData);
          setLogManual(`âœ… Loaded ${usersData.length} users. Search and select a user.`);
        } catch(e) {
          setLogManual('ğŸ’€ Error: ' + e.message);
        }
      }

      // Filter users on search input
      useEffect(() => {
        if (!searchUser.trim()) {
          setFilteredUsers(usersManual);
          return;
        }
        const lower = searchUser.toLowerCase();
        setFilteredUsers(
          usersManual.filter(u =>
            u.username.toLowerCase().includes(lower) || u.userId.toString().includes(lower)
          )
        );
      }, [searchUser, usersManual]);

      // Change single user rank
      async function changeSingleUserRank() {
        setLogManual('â³ Changing user rank...');
        if (!cookieManual || !groupIdManual || !selectedUser || !newRankManual) {
          setLogManual('âš ï¸ Fill all fields and select a user.');
          return;
        }
        try {
          const res = await fetch('/changeUserRank', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              cookie: cookieManual,
              groupId: Number(groupIdManual),
              userId: selectedUser.userId,
              newRankId: Number(newRankManual)
            }),
          });
          const data = await res.json();
          if (data.success) {
            setLogManual(`âœ… Successfully changed rank for user ${selectedUser.username} (${selectedUser.userId})`);
          } else {
            setLogManual('âŒ Failed: ' + data.error);
          }
        } catch(e) {
          setLogManual('ğŸ’¥ Could not contact backend: ' + e.message);
        }
      }

      return (
        <div className="bg-white rounded-2xl shadow-lg max-w-3xl w-full p-8">
          <h1 className="text-3xl font-semibold mb-8 text-center">Roblox Rank Manager</h1>

          {/* Menu */}
          <div className="flex justify-center gap-4 mb-8">
            <button
              onClick={() => setMode('revert')}
              className={`px-6 py-2 rounded-xl font-medium shadow-md transition ${
                mode === 'revert'
                  ? 'bg-indigo-600 text-white shadow-indigo-400'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              Revert Abuse
            </button>
            <button
              onClick={() => setMode('manual')}
              className={`px-6 py-2 rounded-xl font-medium shadow-md transition ${
                mode === 'manual'
                  ? 'bg-green-500 text-white shadow-green-400'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              Change Single User Rank
            </button>
          </div>

          {/* Revert Abuse Section */}
          {mode === 'revert' && (
            <div className="space-y-6">
              <div>
                <label className="block text-gray-700 font-medium mb-2">ğŸ”‘ Security Cookie</label>
                <input
                  type="password"
                  placeholder=".ROBLOSECURITY cookie"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400"
                  value={cookieRevert}
                  onChange={e => setCookieRevert(e.target.value)}
                />
              </div>

              <div>
                <label className="block text-gray-700 font-medium mb-2">ğŸ‘¥ Group ID</label>
                <input
                  type="number"
                  placeholder="Group ID"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400"
                  value={groupIdRevert}
                  onChange={e => setGroupIdRevert(e.target.value)}
                />
              </div>

              <button
                onClick={fetchRanksRevert}
                className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
              >
                ğŸ“¥ Fetch Group Ranks
              </button>

              <div className="flex flex-col sm:flex-row sm:space-x-4">
                <div className="flex-1 mt-4 sm:mt-0">
                  <label className="block text-gray-700 font-medium mb-2">ğŸ¯ Current Rank</label>
                  <select
                    className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400"
                    value={currentRankIdRevert}
                    onChange={e => setCurrentRankIdRevert(e.target.value)}
                    disabled={ranksRevert.length === 0}
                  >
                    <option value="">Select current rank</option>
                    {ranksRevert.map(role => (
                      <option key={role.id} value={role.id}>
                        ({role.rank}) {role.name}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="flex-1 mt-4 sm:mt-0">
                  <label className="block text-gray-700 font-medium mb-2">â†©ï¸ New Rank</label>
                  <select
                    className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400"
                    value={newRankIdRevert}
                    onChange={e => setNewRankIdRevert(e.target.value)}
                    disabled={ranksRevert.length === 0}
                  >
                    <option value="">Select new rank</option>
                    {ranksRevert.map(role => (
                      <option key={role.id} value={role.id}>
                        ({role.rank}) {role.name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <button
                onClick={startRevert}
                className="w-full py-3 mt-4 bg-gradient-to-r from-green-400 to-teal-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
              >
                ğŸš€ Start Revert
              </button>

              <div className="mt-6 p-4 bg-gray-100 rounded-xl shadow-inner h-48 overflow-y-auto">
                <pre className="text-sm text-gray-700 whitespace-pre-wrap">{logRevert}</pre>
              </div>
            </div>
          )}

          {/* Manual Single User Rank Section */}
          {mode === 'manual' && (
            <div className="space-y-6">
              <div>
                <label className="block text-gray-700 font-medium mb-2">ğŸ”‘ Security Cookie</label>
                <input
                  type="password"
                  placeholder=".ROBLOSECURITY cookie"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400"
                  value={cookieManual}
                  onChange={e => setCookieManual(e.target.value)}
                />
              </div>

              <div>
                <label className="block text-gray-700 font-medium mb-2">ğŸ‘¥ Group ID</label>
                <input
                  type="number"
                  placeholder="Group ID"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400"
                  value={groupIdManual}
                  onChange={e => setGroupIdManual(e.target.value)}
                />
              </div>

              <button
                onClick={fetchUsersManual}
                className="w-full py-3 bg-gradient-to-r from-green-400 to-teal-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
              >
                ğŸ“¥ Fetch Users & Ranks
              </button>

              <input
                type="text"
                placeholder="ğŸ” Search user by name or ID"
                className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400"
                value={searchUser}
                onChange={e => setSearchUser(e.target.value)}
                disabled={usersManual.length === 0}
              />

              <div className="max-h-48 overflow-y-auto bg-gray-100 rounded-xl shadow-inner p-2 text-gray-700">
                {filteredUsers.length === 0 && <div className="text-center py-6 text-gray-400">No users found</div>}
                {filteredUsers.map(user => (
                  <div
                    key={user.userId}
                    onClick={() => setSelectedUser(user)}
                    className={`p-2 cursor-pointer rounded-md ${
                      selectedUser?.userId === user.userId
                        ? 'bg-green-500 text-white'
                        : 'hover:bg-green-200 hover:text-green-900'
                    }`}
                  >
                    {user.username} ({user.userId})
                  </div>
                ))}
              </div>

              <label className="block text-gray-700 font-medium mt-4 mb-2">â†©ï¸ Select New Rank</label>
              <select
                className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400"
                value={newRankManual}
                onChange={e => setNewRankManual(e.target.value)}
                disabled={ranksManual.length === 0}
              >
                <option value="">Select new rank</option>
                {ranksManual.map(role => (
                  <option key={role.id} value={role.id}>
                    ({role.rank}) {role.name}
                  </option>
                ))}
              </select>

              <button
                onClick={changeSingleUserRank}
                className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
              >
                ğŸš€ Change Rank
              </button>

              <div className="mt-6 p-4 bg-gray-100 rounded-xl shadow-inner h-32 overflow-y-auto">
                <pre className="text-sm text-gray-700 whitespace-pre-wrap">{logManual}</pre>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
