<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roblox Rank Manager</title>
  <style>
    body {
      background: #0f172a;
      color: #f8fafc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      min-height: 100vh;
      margin: 0;
    }
    h1 {
      margin-bottom: 1.5rem;
      font-size: 2rem;
      font-weight: 700;
    }
    label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: #cbd5e1;
    }
    input, select, button {
      width: 300px;
      max-width: 90vw;
      padding: 0.7rem 1rem;
      font-size: 1rem;
      border-radius: 0.6rem;
      border: none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      outline-offset: 2px;
      outline-color: transparent;
      transition: outline-color 0.2s ease;
    }
    input:focus, select:focus {
      outline-color: #3b82f6;
    }
    button {
      cursor: pointer;
      margin-top: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      box-shadow: 0 4px 8px rgba(99, 102, 241, 0.6);
      transition: background 0.3s ease;
    }
    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:hover:not(:disabled) {
      background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%);
    }
    .section {
      background: #1e293b;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      margin-top: 2rem;
      width: 350px;
      max-width: 95vw;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.6);
    }
    .tabs {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .tab {
      cursor: pointer;
      padding: 0.5rem 1.2rem;
      border-radius: 1rem;
      background: #334155;
      color: #94a3b8;
      font-weight: 600;
      user-select: none;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .tab.active {
      background: #6366f1;
      color: white;
      box-shadow: 0 2px 6px rgba(99, 102, 241, 0.8);
    }
    .log {
      background: #334155;
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 0.8rem;
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace, monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      color: #d1d5db;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Roblox Rank Manager</h1>

  <div class="tabs">
    <div class="tab active" id="tab-revert">Revert Abuse</div>
    <div class="tab" id="tab-manual">Manual Rank Change</div>
  </div>

  <!-- COMMON COOKIE INPUT -->
  <label for="cookieInput">üîë Enter your Security Cookie</label>
  <input type="password" id="cookieInput" placeholder=".ROBLOSECURITY cookie" autocomplete="off" spellcheck="false" />

  <button id="btnFetchGroups" disabled>Fetch Groups</button>

  <!-- Group selector -->
  <div class="section hidden" id="groupSection">
    <label for="groupSelect">üë• Select Group</label>
    <select id="groupSelect" disabled>
      <option>Loading groups...</option>
    </select>

    <button id="btnFetchRanks" disabled>Fetch Ranks</button>
  </div>

  <!-- Revert Abuse Section -->
  <div class="section" id="revertSection">
    <label for="currentRankRevert">üéØ Current Rank</label>
    <select id="currentRankRevert" disabled>
      <option>Select current rank</option>
    </select>

    <label for="newRankRevert">‚Ü©Ô∏è New Rank</label>
    <select id="newRankRevert" disabled>
      <option>Select new rank</option>
    </select>

    <button id="btnStartRevert" disabled>üöÄ Start Revert</button>

    <div class="log" id="logRevert">Revert logs will appear here...</div>
  </div>

  <!-- Manual Rank Change Section -->
  <div class="section hidden" id="manualSection">
    <label for="currentRankManual">üéØ Select Rank to List Users</label>
    <select id="currentRankManual" disabled>
      <option>Select rank</option>
    </select>

    <button id="btnFetchUsers" disabled>Fetch Users</button>

    <label for="userSearch">Search Users by Username or ID</label>
    <input type="text" id="userSearch" placeholder="Search user..." disabled />

    <label for="userSelect">Select User</label>
    <select id="userSelect" disabled>
      <option>Select a user</option>
    </select>

    <label for="newRankManual">‚Ü©Ô∏è New Rank</label>
    <select id="newRankManual" disabled>
      <option>Select new rank</option>
    </select>

    <button id="btnChangeManual" disabled>üöÄ Change Rank</button>

    <div class="log" id="logManual">Manual logs will appear here...</div>
  </div>

  <script>
    // Elements
    const cookieInput = document.getElementById('cookieInput');
    const btnFetchGroups = document.getElementById('btnFetchGroups');
    const groupSection = document.getElementById('groupSection');
    const groupSelect = document.getElementById('groupSelect');
    const btnFetchRanks = document.getElementById('btnFetchRanks');

    const revertSection = document.getElementById('revertSection');
    const currentRankRevert = document.getElementById('currentRankRevert');
    const newRankRevert = document.getElementById('newRankRevert');
    const btnStartRevert = document.getElementById('btnStartRevert');
    const logRevert = document.getElementById('logRevert');

    const manualSection = document.getElementById('manualSection');
    const currentRankManual = document.getElementById('currentRankManual');
    const btnFetchUsers = document.getElementById('btnFetchUsers');
    const userSearch = document.getElementById('userSearch');
    const userSelect = document.getElementById('userSelect');
    const newRankManual = document.getElementById('newRankManual');
    const btnChangeManual = document.getElementById('btnChangeManual');
    const logManual = document.getElementById('logManual');

    const tabRevert = document.getElementById('tab-revert');
    const tabManual = document.getElementById('tab-manual');

    // State
    let groups = [];
    let ranks = [];
    let users = [];

    // Initial states
    btnFetchGroups.disabled = true;
    btnFetchRanks.disabled = true;
    currentRankRevert.disabled = true;
    newRankRevert.disabled = true;
    btnStartRevert.disabled = true;
    currentRankManual.disabled = true;
    btnFetchUsers.disabled = true;
    userSearch.disabled = true;
    userSelect.disabled = true;
    newRankManual.disabled = true;
    btnChangeManual.disabled = true;

    // Enable Fetch Groups button only if cookie input not empty
    cookieInput.addEventListener('input', () => {
      btnFetchGroups.disabled = cookieInput.value.trim() === '';
      resetAfterGroups();
    });

    // Tab switching
    tabRevert.addEventListener('click', () => {
      tabRevert.classList.add('active');
      tabManual.classList.remove('active');
      revertSection.style.display = 'block';
      manualSection.style.display = 'none';
    });

    tabManual.addEventListener('click', () => {
      tabManual.classList.add('active');
      tabRevert.classList.remove('active');
      manualSection.style.display = 'block';
      revertSection.style.display = 'none';
    });

    // Reset UI parts after groups change
    function resetAfterGroups() {
      groupSection.classList.add('hidden');
      groupSelect.innerHTML = '<option>Loading groups...</option>';
      btnFetchRanks.disabled = true;

      // Revert reset
      currentRankRevert.innerHTML = '<option>Select current rank</option>';
      newRankRevert.innerHTML = '<option>Select new rank</option>';
      currentRankRevert.disabled = true;
      newRankRevert.disabled = true;
      btnStartRevert.disabled = true;
      logRevert.textContent = 'Revert logs will appear here...';

      // Manual reset
      currentRankManual.innerHTML = '<option>Select rank</option>';
      btnFetchUsers.disabled = true;
      userSearch.value = '';
      userSearch.disabled = true;
      userSelect.innerHTML = '<option>Select a user</option>';
      userSelect.disabled = true;
      newRankManual.innerHTML = '<option>Select new rank</option>';
      newRankManual.disabled = true;
      btnChangeManual.disabled = true;
      logManual.textContent = 'Manual logs will appear here...';
    }

    // Fetch groups button click
    btnFetchGroups.addEventListener('click', async () => {
      const cookie = cookieInput.value.trim();
      if (!cookie) return;

      btnFetchGroups.disabled = true;
      btnFetchGroups.textContent = 'Fetching groups...';
      resetAfterGroups();

      try {
        const res = await fetch('/groups', {
          headers: { 'x-cookie': cookie }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        groups = await res.json();

        if (!groups.length) {
          throw new Error('No groups found or no manage permissions.');
        }

        // Populate group select
        groupSelect.innerHTML = '<option disabled selected>Select a group</option>';
        groups.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = g.name;
          groupSelect.appendChild(opt);
        });

        groupSection.classList.remove('hidden');
        groupSelect.disabled = false;
        btnFetchRanks.disabled = false;

        btnFetchGroups.textContent = 'Fetch Groups';
      } catch (err) {
        btnFetchGroups.textContent = 'Fetch Groups';
        alert('‚ùå Failed to load groups: ' + err.message);
      } finally {
        btnFetchGroups.disabled = false;
      }
    });

    // Fetch ranks button click
    btnFetchRanks.addEventListener('click', async () => {
      const groupId = parseInt(groupSelect.value);
      if (!groupId) {
        alert('‚ö†Ô∏è Select a group first!');
        return;
      }

      btnFetchRanks.disabled = true;
      btnFetchRanks.textContent = 'Fetching ranks...';

      try {
        const res = await fetch(`/roles?groupId=${groupId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        ranks = await res.json();

        if (!Array.isArray(ranks) || ranks.length === 0) {
          throw new Error('No ranks found for group');
        }

        // Fill revert ranks selects
        currentRankRevert.innerHTML = '<option disabled selected>Select current rank</option>';
        newRankRevert.innerHTML = '<option disabled selected>Select new rank</option>';
        ranks.forEach(r => {
          const option1 = document.createElement('option');
          option1.value = r.id;
          option1.textContent = `(${r.rank}) ${r.name}`;
          currentRankRevert.appendChild(option1);

          const option2 = option1.cloneNode(true);
          newRankRevert.appendChild(option2);
        });
        currentRankRevert.disabled = false;
        newRankRevert.disabled = false;
        btnStartRevert.disabled = false;

        // Fill manual ranks select
        currentRankManual.innerHTML = '<option disabled selected>Select rank</option>';
        newRankManual.innerHTML = '<option disabled selected>Select new rank</option>';
        ranks.forEach(r => {
          const option1 = document.createElement('option');
          option1.value = r.id;
          option1.textContent = `(${r.rank}) ${r.name}`;
          currentRankManual.appendChild(option1);

          const option2 = option1.cloneNode(true);
          newRankManual.appendChild(option2);
        });
        currentRankManual.disabled = false;
        newRankManual.disabled = false;
        btnFetchUsers.disabled = false;
        userSearch.disabled = false;

        btnFetchRanks.textContent = 'Fetch Ranks';
      } catch (err) {
        alert('‚ùå Failed to load ranks: ' + err.message);
        btnFetchRanks.textContent = 'Fetch Ranks';
      } finally {
        btnFetchRanks.disabled = false;
      }
    });

    // Start revert button
    btnStartRevert.addEventListener('click', async () => {
      const cookie = cookieInput.value.trim();
      const groupId = parseInt(groupSelect.value);
      const currentRankId = parseInt(currentRankRevert.value);
      const newRankId = parseInt(newRankRevert.value);

      if (!cookie || !groupId || !currentRankId || !newRankId) {
        alert('‚ö†Ô∏è Fill all revert fields!');
        return;
      }

      btnStartRevert.disabled = true;
      logRevert.textContent = '‚è≥ Reverting...';

      try {
        const res = await fetch('/revert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookie, groupId, currentRankId, newRankId }),
        });
        const data = await res.json();

        if (data.success) {
          logRevert.textContent = `‚úÖ Reverted ${data.count} users\n\n${(data.logs || []).join('\n')}`;
        } else {
          logRevert.textContent = `‚ùå Error: ${data.error}`;
        }
      } catch (err) {
        logRevert.textContent = `üí• Failed contacting server: ${err.message}`;
      } finally {
        btnStartRevert.disabled = false;
      }
    });

    // Fetch users button (manual mode)
    btnFetchUsers.addEventListener('click', async () => {
      const cookie = cookieInput.value.trim();
      const groupId = parseInt(groupSelect.value);
      const rankId = parseInt(currentRankManual.value);

      if (!cookie || !groupId || !rankId) {
        alert('‚ö†Ô∏è Fill all manual user fetch fields!');
        return;
      }

      btnFetchUsers.disabled = true;
      logManual.textContent = '‚è≥ Fetching users...';
      userSelect.innerHTML = '<option>Loading users...</option>';
      userSelect.disabled = true;

      try {
        const res = await fetch(`/users?groupId=${groupId}&rankId=${rankId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        users = await res.json();

        if (!Array.isArray(users) || users.length === 0) {
          logManual.textContent = 'No users found for that rank.';
          userSelect.innerHTML = '<option>No users found</option>';
          userSelect.disabled = true;
          return;
        }

        userSelect.innerHTML = '<option disabled selected>Select a user</option>';
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.userId;
          opt.textContent = `${u.username} (ID: ${u.userId})`;
          userSelect.appendChild(opt);
        });
        userSelect.disabled = false;
        logManual.textContent = '‚úÖ Users loaded.';
      } catch (err) {
        logManual.textContent = `‚ùå Failed to load users: ${err.message}`;
        userSelect.innerHTML = '<option>Error loading users</option>';
        userSelect.disabled = true;
      } finally {
        btnFetchUsers.disabled = false;
      }
    });

    // Search user input filtering
    userSearch.addEventListener('input', () => {
      const term = userSearch.value.trim().toLowerCase();
      if (!term) {
        // Show all
        userSelect.innerHTML = '<option disabled selected>Select a user</option>';
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.userId;
          opt.textContent = `${u.username} (ID: ${u.userId})`;
          userSelect.appendChild(opt);
        });
        userSelect.disabled = false;
        return;
      }

      // Filter users by username or userId (string compare)
      const filtered = users.filter(u =>
        u.username.toLowerCase().includes(term) || u.userId.toString().includes(term)
      );

      if (filtered.length === 0) {
        userSelect.innerHTML = '<option disabled>No users found</option>';
        userSelect.disabled = true;
        return;
      }

      userSelect.innerHTML = '<option disabled selected>Select a user</option>';
      filtered.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.userId;
        opt.textContent = `${u.username} (ID: ${u.userId})`;
        userSelect.appendChild(opt);
      });
      userSelect.disabled = false;
    });

    // Enable change rank button when user selected & new rank selected
    function checkManualChangeEnable() {
      btnChangeManual.disabled = !(userSelect.value && newRankManual.value);
    }

    userSelect.addEventListener('change', checkManualChangeEnable);
    newRankManual.addEventListener('change', checkManualChangeEnable);

    // Change rank manual button
    btnChangeManual.addEventListener('click', async () => {
      const cookie = cookieInput.value.trim();
      const groupId = parseInt(groupSelect.value);
      const userId = parseInt(userSelect.value);
      const newRank = parseInt(newRankManual.value);

      if (!cookie || !groupId || !userId || !newRank) {
        alert('‚ö†Ô∏è Fill all manual change fields!');
        return;
      }

      btnChangeManual.disabled = true;
      logManual.textContent = '‚è≥ Changing user rank...';

      try {
        const res = await fetch('/manual', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookie, groupId, userId, newRank }),
        });
        const data = await res.json();

        if (data.success) {
          logManual.textContent = `‚úÖ Changed rank of user ID ${userId}`;
        } else {
          logManual.textContent = `‚ùå Error: ${data.error}`;
        }
      } catch (err) {
        logManual.textContent = `üí• Failed contacting server: ${err.message}`;
      } finally {
        btnChangeManual.disabled = false;
      }
    });

    // Initialize UI: start on revert tab, manual hidden
    revertSection.style.display = 'block';
    manualSection.style.display = 'none';

  </script>

</body>
</html>
