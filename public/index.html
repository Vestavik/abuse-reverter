<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roblox Rank Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    /* Custom scroll for logs and users list */
    .scrollbox {
      max-height: 200px;
      overflow-y: auto;
    }
    .user-item:hover {
      background-color: #a7f3d0; /* Tailwind green-200 */
      color: #065f46; /* Tailwind green-900 */
      cursor: pointer;
    }
    .user-item.selected {
      background-color: #22c55e; /* Tailwind green-500 */
      color: white;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="bg-white rounded-2xl shadow-lg max-w-4xl w-full p-8">

    <h1 class="text-3xl font-semibold mb-8 text-center">Roblox Rank Manager</h1>

    <!-- Tabs -->
    <div class="flex justify-center gap-4 mb-8">
      <button id="tabRevertBtn" class="px-6 py-2 rounded-xl font-medium shadow-md bg-indigo-600 text-white" type="button">Revert Abuse</button>
      <button id="tabManualBtn" class="px-6 py-2 rounded-xl font-medium shadow-md bg-gray-100 text-gray-600 hover:bg-gray-200" type="button">Change Single User Rank</button>
    </div>

    <!-- Revert Abuse Tab -->
    <div id="tabRevert" class="">
      <div class="space-y-6">
        <div>
          <label class="block text-gray-700 font-medium mb-2">üîë Security Cookie</label>
          <input id="cookieRevert" type="password" placeholder=".ROBLOSECURITY cookie"
            class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400" />
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-2">üë• Group ID</label>
          <input id="groupIdRevert" type="number" placeholder="Group ID"
            class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400" />
        </div>

        <button id="fetchRanksRevertBtn"
          class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
          type="button">üì• Fetch Group Ranks</button>

        <div class="flex flex-col sm:flex-row sm:space-x-4">
          <div class="flex-1 mt-4 sm:mt-0">
            <label class="block text-gray-700 font-medium mb-2">üéØ Current Rank</label>
            <select id="currentRankIdRevert"
              class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400" disabled>
              <option>Select current rank</option>
            </select>
          </div>

          <div class="flex-1 mt-4 sm:mt-0">
            <label class="block text-gray-700 font-medium mb-2">‚Ü©Ô∏è New Rank</label>
            <select id="newRankIdRevert"
              class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400" disabled>
              <option>Select new rank</option>
            </select>
          </div>
        </div>

        <button id="startRevertBtn"
          class="w-full py-3 mt-4 bg-gradient-to-r from-green-400 to-teal-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
          type="button">üöÄ Start Revert</button>

        <div id="logRevert" class="mt-6 p-4 bg-gray-100 rounded-xl shadow-inner scrollbox whitespace-pre-wrap text-sm text-gray-700">Revert logs will appear here...</div>
      </div>
    </div>

    <!-- Manual Rank Change Tab -->
    <div id="tabManual" class="hidden">
      <div class="space-y-6">
        <div>
          <label class="block text-gray-700 font-medium mb-2">üîë Security Cookie</label>
          <input id="cookieManual" type="password" placeholder=".ROBLOSECURITY cookie"
            class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400" />
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-2">üë• Group ID</label>
          <input id="groupIdManual" type="number" placeholder="Group ID"
            class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400" />
        </div>

        <button id="fetchUsersManualBtn"
          class="w-full py-3 bg-gradient-to-r from-green-400 to-teal-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
          type="button">üì• Fetch Users & Ranks</button>

        <input id="searchUserInput" type="text" placeholder="üîç Search user by name or ID"
          class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400" disabled />

        <div id="usersList" class="scrollbox bg-gray-100 rounded-xl shadow-inner p-2 text-gray-700"></div>

        <label class="block text-gray-700 font-medium mt-4 mb-2">‚Ü©Ô∏è Select New Rank</label>
        <select id="newRankManual"
          class="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-green-400" disabled>
          <option>Select new rank</option>
        </select>

        <button id="changeRankBtn"
          class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
          type="button">üöÄ Change Rank</button>

        <div id="logManual" class="mt-6 p-4 bg-gray-100 rounded-xl shadow-inner scrollbox whitespace-pre-wrap text-sm text-gray-700">Manual logs will appear here...</div>
      </div>
    </div>
  </div>

  <script>
    // Tabs switching
    const tabRevertBtn = document.getElementById('tabRevertBtn');
    const tabManualBtn = document.getElementById('tabManualBtn');
    const tabRevert = document.getElementById('tabRevert');
    const tabManual = document.getElementById('tabManual');

    tabRevertBtn.onclick = () => {
      tabRevert.classList.remove('hidden');
      tabManual.classList.add('hidden');
      tabRevertBtn.classList.add('bg-indigo-600', 'text-white');
      tabRevertBtn.classList.remove('bg-gray-100', 'text-gray-600');
      tabManualBtn.classList.remove('bg-green-500', 'text-white');
      tabManualBtn.classList.add('bg-gray-100', 'text-gray-600');
    };
    tabManualBtn.onclick = () => {
      tabManual.classList.remove('hidden');
      tabRevert.classList.add('hidden');
      tabManualBtn.classList.add('bg-green-500', 'text-white');
      tabManualBtn.classList.remove('bg-gray-100', 'text-gray-600');
      tabRevertBtn.classList.remove('bg-indigo-600', 'text-white');
      tabRevertBtn.classList.add('bg-gray-100', 'text-gray-600');
    };

    // Revert Abuse variables
    const cookieRevertInput = document.getElementById('cookieRevert');
    const groupIdRevertInput = document.getElementById('groupIdRevert');
    const fetchRanksRevertBtn = document.getElementById('fetchRanksRevertBtn');
    const currentRankIdRevertSelect = document.getElementById('currentRankIdRevert');
    const newRankIdRevertSelect = document.getElementById('newRankIdRevert');
    const startRevertBtn = document.getElementById('startRevertBtn');
    const logRevert = document.getElementById('logRevert');

    fetchRanksRevertBtn.onclick = async () => {
      const groupId = groupIdRevertInput.value.trim();
      if (!groupId) {
        logRevert.textContent = '‚ö†Ô∏è Please enter a Group ID';
        return;
      }
      logRevert.textContent = '‚è≥ Fetching ranks...';

      try {
        const res = await fetch(`/roles?groupId=${groupId}`);
        if (!res.ok) throw new Error('Failed fetching ranks');
        const roles = await res.json();
        if (!Array.isArray(roles)) throw new Error('Invalid roles data');

        currentRankIdRevertSelect.innerHTML = '<option value="">Select current rank</option>';
        newRankIdRevertSelect.innerHTML = '<option value="">Select new rank</option>';

        roles.forEach(r => {
          const option1 = document.createElement('option');
          option1.value = r.id;
          option1.textContent = `(${r.rank}) ${r.name}`;
          currentRankIdRevertSelect.appendChild(option1);

          const option2 = option1.cloneNode(true);
          newRankIdRevertSelect.appendChild(option2);
        });

        currentRankIdRevertSelect.disabled = false;
        newRankIdRevertSelect.disabled = false;
        logRevert.textContent = '‚úÖ Ranks loaded!';
      } catch (e) {
        logRevert.textContent = 'üíÄ Error: ' + e.message;
      }
    };

    startRevertBtn.onclick = async () => {
      const cookie = cookieRevertInput.value.trim();
      const groupId = parseInt(groupIdRevertInput.value.trim());
      const currentRankId = parseInt(currentRankIdRevertSelect.value);
      const newRankId = parseInt(newRankIdRevertSelect.value);

      if (!cookie || !groupId || !currentRankId || !newRankId) {
        logRevert.textContent = '‚ö†Ô∏è Fill all fields correctly.';
        return;
      }

      logRevert.textContent = '‚è≥ Reverting...';

      try {
        const res = await fetch('/revert', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ cookie, groupId, currentRankId, newRankId }),
        });
        const data = await res.json();

        if (data.success) {
          logRevert.textContent = `‚úÖ Reverted ${data.count} users\n\n${(data.logs || []).join('\n')}`;
        } else {
          logRevert.textContent = `‚ùå Failed: ${data.error}`;
        }
      } catch (e) {
        logRevert.textContent = 'üí• Backend error: ' + e.message;
      }
    };

    // Manual tab variables
    const cookieManualInput = document.getElementById('cookieManual');
    const groupIdManualInput = document.getElementById('groupIdManual');
    const fetchUsersManualBtn = document.getElementById('fetchUsersManualBtn');
    const searchUserInput = document.getElementById('searchUserInput');
    const usersListDiv = document.getElementById('usersList');
    const newRankManualSelect = document.getElementById('newRankManual');
    const changeRankBtn = document.getElementById('changeRankBtn');
    const logManual = document.getElementById('logManual');

    let manualUsers = [];
    let manualRanks = [];
    let selectedManualUser = null;

    fetchUsersManualBtn.onclick = async () => {
      const cookie = cookieManualInput.value.trim();
      const groupId = groupIdManualInput.value.trim();
      if (!cookie || !groupId) {
        logManual.textContent = '‚ö†Ô∏è Fill cookie and group ID first.';
        return;
      }
      logManual.textContent = '‚è≥ Fetching users and ranks...';
      usersListDiv.innerHTML = '';
      searchUserInput.value = '';
      selectedManualUser = null;
      newRankManualSelect.innerHTML = '<option>Select new rank</option>';
      newRankManualSelect.disabled = true;
      searchUserInput.disabled = true;
      changeRankBtn.disabled = true;

      try {
        // Fetch ranks
        const ranksRes = await fetch(`/roles?groupId=${groupId}`);
        if (!ranksRes.ok) throw new Error('Failed fetching ranks');
        const ranksData = await ranksRes.json();
        if (!Array.isArray(ranksData)) throw new Error('Invalid ranks data');
        manualRanks = ranksData;

        newRankManualSelect.innerHTML = '<option value="">Select new rank</option>';
        manualRanks.forEach(r => {
          const option = document.createElement('option');
          option.value = r.id;
          option.textContent = `(${r.rank}) ${r.name}`;
          newRankManualSelect.appendChild(option);
        });
        newRankManualSelect.disabled = false;

        // Fetch users (your backend must support this endpoint)
        const usersRes = await fetch(`/users?cookie=${encodeURIComponent(cookie)}&groupId=${groupId}`);
        if (!usersRes.ok) throw new Error('Failed fetching users');
        const usersData = await usersRes.json();
        if (!Array.isArray(usersData)) throw new Error('Invalid users data');
        manualUsers = usersData;

        if (manualUsers.length === 0) {
          usersListDiv.textContent = 'No users found in group.';
          searchUserInput.disabled = true;
        } else {
          usersListDiv.innerHTML = '';
          manualUsers.forEach(u => {
            const div = document.createElement('div');
            div.textContent = `${u.username} (${u.userId})`;
            div.className = 'user-item p-2 rounded-md';
            div.onclick = () => selectManualUser(u, div);
            usersListDiv.appendChild(div);
          });
          searchUserInput.disabled = false;
          changeRankBtn.disabled = true;
          logManual.textContent = `‚úÖ Loaded ${manualUsers.length} users. Search and select a user.`;
        }
      } catch (e) {
        logManual.textContent = 'üíÄ Error: ' + e.message;
      }
    };

    function selectManualUser(user, divElement) {
      selectedManualUser = user;
      // Remove previous selection
      [...usersListDiv.children].forEach(child => child.classList.remove('selected'));
      divElement.classList.add('selected');
      changeRankBtn.disabled = false;
      logManual.textContent = `Selected user: ${user.username} (${user.userId})`;
    }

    searchUserInput.oninput = () => {
      const val = searchUserInput.value.toLowerCase();
      usersListDiv.innerHTML = '';
      manualUsers.filter(u =>
        u.username.toLowerCase().includes(val) ||
        u.userId.toString().includes(val)
      ).forEach(u => {
        const div = document.createElement('div');
        div.textContent = `${u.username} (${u.userId})`;
        div.className = 'user-item p-2 rounded-md' + (selectedManualUser?.userId === u.userId ? ' selected' : '');
        div.onclick = () => selectManualUser(u, div);
        usersListDiv.appendChild(div);
      });

      if (usersListDiv.children.length === 0) {
        usersListDiv.textContent = 'No users found';
      }
    };

    changeRankBtn.onclick = async () => {
      if (!selectedManualUser) {
        logManual.textContent = '‚ö†Ô∏è Select a user first.';
        return;
      }
      const cookie = cookieManualInput.value.trim();
      const groupId = parseInt(groupIdManualInput.value.trim());
      const newRankId = parseInt(newRankManualSelect.value);
      if (!cookie || !groupId || !newRankId) {
        logManual.textContent = '‚ö†Ô∏è Fill all fields correctly.';
        return;
      }

      logManual.textContent = '‚è≥ Changing user rank...';

      try {
        const res = await fetch('/changeUserRank', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cookie,
            groupId,
            userId: selectedManualUser.userId,
            newRankId
          }),
        });
        const data = await res.json();
        if (data.success) {
          logManual.textContent = `‚úÖ Successfully changed rank for user ${selectedManualUser.username} (${selectedManualUser.userId})`;
        } else {
          logManual.textContent = `‚ùå Failed: ${data.error}`;
        }
      } catch (e) {
        logManual.textContent = 'üí• Backend error: ' + e.message;
      }
    };
  </script>
</body>
</html>
