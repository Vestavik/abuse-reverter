<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roblox Rank Manager</title>
  <script defer src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-3xl font-bold mb-8">Roblox Rank Manager</h1>

  <!-- Step 1: Enter Cookie -->
  <div id="cookieStep" class="w-full max-w-lg space-y-4">
    <label class="block font-semibold text-lg">ğŸ”‘ Enter your .ROBLOSECURITY cookie</label>
    <input
      id="cookieInput"
      type="password"
      class="w-full p-3 rounded-xl border border-gray-700 bg-gray-800"
      placeholder="Paste your Roblox security cookie here"
    />
    <button
      id="btnFetchGroups"
      class="w-full bg-indigo-600 hover:bg-indigo-700 rounded-xl p-3 font-semibold transition disabled:opacity-50"
      disabled
    >
      Fetch Groups
    </button>
    <p id="cookieError" class="text-red-500"></p>
  </div>

  <!-- Step 2: Select Group -->
  <div id="groupStep" class="hidden w-full max-w-lg space-y-4">
    <label class="block font-semibold text-lg">ğŸ‘¥ Select a group you manage</label>
    <select id="groupSelect" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"></select>
    <button
      id="btnFetchRoles"
      class="w-full bg-indigo-600 hover:bg-indigo-700 rounded-xl p-3 font-semibold transition"
      disabled
    >
      Fetch Roles
    </button>
    <p id="groupError" class="text-red-500"></p>
  </div>

  <!-- Step 3: Select Mode -->
  <div id="modeStep" class="hidden w-full max-w-lg space-y-4">
    <label class="block font-semibold text-lg">âš™ï¸ Choose mode</label>
    <div class="flex space-x-4">
      <button id="modeRevert" class="flex-1 bg-blue-600 hover:bg-blue-700 rounded-xl p-3 font-semibold transition">
        Revert Abuse
      </button>
      <button id="modeManual" class="flex-1 bg-green-600 hover:bg-green-700 rounded-xl p-3 font-semibold transition">
        Manual Rank Change
      </button>
    </div>
  </div>

  <!-- Step 4A: Revert Abuse -->
  <div id="revertStep" class="hidden w-full max-w-lg space-y-4">

    <label class="block font-semibold text-lg">ğŸ¯ Select current rank</label>
    <select id="currentRankRevert" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"></select>

    <label class="block font-semibold text-lg">â†©ï¸ Select new rank</label>
    <select id="newRankRevert" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"></select>

    <button id="btnStartRevert" class="w-full bg-blue-600 hover:bg-blue-700 rounded-xl p-3 font-semibold transition">
      ğŸš€ Start Revert
    </button>

    <pre id="logRevert" class="bg-gray-800 rounded-xl p-4 text-sm max-h-48 overflow-y-auto"></pre>
  </div>

  <!-- Step 4B: Manual Rank Change -->
  <div id="manualStep" class="hidden w-full max-w-lg space-y-4">

    <label class="block font-semibold text-lg">ğŸ¯ Select rank to list users</label>
    <select id="currentRankManual" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"></select>
    <button id="btnFetchUsers" class="w-full bg-green-600 hover:bg-green-700 rounded-xl p-3 font-semibold transition">
      Fetch Users
    </button>

    <label class="block font-semibold text-lg">Search users by username or ID</label>
    <input
      id="searchUserInput"
      type="text"
      placeholder="Search users..."
      class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"
      disabled
    />

    <label class="block font-semibold text-lg">Select a user</label>
    <select id="userSelect" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700" disabled></select>

    <label class="block font-semibold text-lg">â†©ï¸ Select new rank</label>
    <select id="newRankManual" class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"></select>

    <button id="btnChangeRank" class="w-full bg-green-600 hover:bg-green-700 rounded-xl p-3 font-semibold transition" disabled>
      ğŸš€ Change Rank
    </button>

    <pre id="logManual" class="bg-gray-800 rounded-xl p-4 text-sm max-h-48 overflow-y-auto"></pre>
  </div>

  <script>
    const cookieInput = document.getElementById('cookieInput');
    const btnFetchGroups = document.getElementById('btnFetchGroups');
    const cookieError = document.getElementById('cookieError');
    const groupStep = document.getElementById('groupStep');
    const groupSelect = document.getElementById('groupSelect');
    const btnFetchRoles = document.getElementById('btnFetchRoles');
    const groupError = document.getElementById('groupError');
    const modeStep = document.getElementById('modeStep');
    const modeRevert = document.getElementById('modeRevert');
    const modeManual = document.getElementById('modeManual');

    const revertStep = document.getElementById('revertStep');
    const currentRankRevert = document.getElementById('currentRankRevert');
    const newRankRevert = document.getElementById('newRankRevert');
    const btnStartRevert = document.getElementById('btnStartRevert');
    const logRevert = document.getElementById('logRevert');

    const manualStep = document.getElementById('manualStep');
    const currentRankManual = document.getElementById('currentRankManual');
    const btnFetchUsers = document.getElementById('btnFetchUsers');
    const searchUserInput = document.getElementById('searchUserInput');
    const userSelect = document.getElementById('userSelect');
    const newRankManual = document.getElementById('newRankManual');
    const btnChangeRank = document.getElementById('btnChangeRank');
    const logManual = document.getElementById('logManual');

    // Enable fetch groups button only if cookie input has some value
    cookieInput.addEventListener('input', () => {
      btnFetchGroups.disabled = !cookieInput.value.trim();
      cookieError.textContent = '';
    });

    btnFetchGroups.addEventListener('click', async () => {
      cookieError.textContent = '';
      groupError.textContent = '';
      btnFetchGroups.disabled = true;

      try {
        const res = await fetch(`/api/groups?cookie=${encodeURIComponent(cookieInput.value.trim())}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const groups = await res.json();

        if (groups.length === 0) {
          cookieError.textContent = 'No manageable groups found in your account.';
          btnFetchGroups.disabled = false;
          return;
        }

        // Populate group select
        groupSelect.innerHTML = '';
        groups.forEach(g => {
          const option = document.createElement('option');
          option.value = g.id;
          option.textContent = `${g.name} (Rank: ${g.rank})`;
          groupSelect.appendChild(option);
        });

        // Show next step
        groupStep.classList.remove('hidden');
        modeStep.classList.remove('hidden');
        btnFetchRoles.disabled = false;

      } catch (err) {
        cookieError.textContent = `âŒ Failed to load groups: ${err.message}`;
        btnFetchGroups.disabled = false;
      }
    });

    btnFetchRoles.addEventListener('click', async () => {
      groupError.textContent = '';
      btnFetchRoles.disabled = true;
      currentRankRevert.innerHTML = '';
      newRankRevert.innerHTML = '';
      currentRankManual.innerHTML = '';
      newRankManual.innerHTML = '';

      const groupId = groupSelect.value;
      try {
        const res = await fetch(`/api/roles?groupId=${groupId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const roles = await res.json();

        // Populate revert ranks
        roles.forEach(role => {
          const opt = document.createElement('option');
          opt.value = role.rank;
          opt.textContent = `(${role.rank}) ${role.name}`;
          currentRankRevert.appendChild(opt.cloneNode(true));
          newRankRevert.appendChild(opt.cloneNode(true));
          currentRankManual.appendChild(opt.cloneNode(true));
          newRankManual.appendChild(opt.cloneNode(true));
        });

        btnFetchRoles.disabled = true;
        btnFetchUsers.disabled = false;
      } catch (err) {
        groupError.textContent = `âŒ Failed to load roles: ${err.message}`;
        btnFetchRoles.disabled = false;
      }
    });

    // Mode selection
    modeRevert.addEventListener('click', () => {
      revertStep.classList.remove('hidden');
      manualStep.classList.add('hidden');
    });
    modeManual.addEventListener('click', () => {
      manualStep.classList.remove('hidden');
      revertStep.classList.add('hidden');
    });

    // Revert abuse logic
    btnStartRevert.addEventListener('click', async () => {
      logRevert.textContent = 'â³ Reverting ranks...';
      const cookie = cookieInput.value.trim();
      const groupId = groupSelect.value;
      const currentRankId = currentRankRevert.value;
      const newRankId = newRankRevert.value;

      if (!cookie || !groupId || !currentRankId || !newRankId) {
        logRevert.textContent = 'âš ï¸ Fill out all fields!';
        return;
      }

      try {
        const res = await fetch('/api/revert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookie, groupId: Number(groupId), currentRankId: Number(currentRankId), newRankId: Number(newRankId) })
        });

        const data = await res.json();
        if (data.success) {
          logRevert.textContent = `âœ… Reverted ${data.count} users\n\n${data.logs.join('\n')}`;
        } else {
          logRevert.textContent = `âŒ Error: ${data.error}`;
        }
      } catch (err) {
        logRevert.textContent = `ğŸ’¥ Could not contact server: ${err.message}`;
      }
    });

    // Manual rank change logic
    btnFetchUsers.addEventListener('click', async () => {
      logManual.textContent = 'â³ Fetching users...';
      const groupId = groupSelect.value;
      const rankId = currentRankManual.value;
      if (!groupId || !rankId) {
        logManual.textContent = 'âš ï¸ Select group and rank first!';
        return;
      }

      try {
        const res = await fetch(`/api/users?groupId=${groupId}&rankId=${rankId}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const users = await res.json();

        userSelect.innerHTML = '';
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.userId;
          opt.textContent = `${u.username} (${u.userId})`;
          userSelect.appendChild(opt);
        });

        userSelect.disabled = false;
        searchUserInput.disabled = false;
        btnChangeRank.disabled = false;
        logManual.textContent = `âœ… Loaded ${users.length} users.`;
      } catch (err) {
        logManual.textContent = `âŒ Failed to load users: ${err.message}`;
      }
    });

    // Search filter for users
    searchUserInput.addEventListener('input', () => {
      const filter = searchUserInput.value.toLowerCase();
      Array.from(userSelect.options).forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(filter) ? '' : 'none';
      });
    });

    btnChangeRank.addEventListener('click', async () => {
      logManual.textContent = 'â³ Changing user rank...';
      const cookie = cookieInput.value.trim();
      const groupId = groupSelect.value;
      const userId = userSelect.value;
      const newRank = newRankManual.value;

      if (!cookie || !groupId || !userId || !newRank) {
        logManual.textContent = 'âš ï¸ Fill out all fields!';
        return;
      }

      try {
        const res = await fetch('/api/manual', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cookie, groupId: Number(groupId), userId: Number(userId), newRank: Number(newRank) })
        });

        const data = await res.json();
        if (data.success) {
          logManual.textContent = `âœ… Successfully changed rank for user ${userId}`;
        } else {
          logManual.textContent = `âŒ Error: ${data.error}`;
        }
      } catch (err) {
        logManual.textContent = `ğŸ’¥ Could not contact server: ${err.message}`;
      }
    });

  </script>

</body>
</html>
