<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roblox Rank Manager - Beyond UI Style</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
  <div id="root" class="w-full max-w-lg"></div>

  <script type="text/babel">

    const { useState, useEffect } = React;

    function RankManager() {
      const [mode, setMode] = useState('revert'); // 'revert' or 'manual'

      // Revert abuse states
      const [cookieRevert, setCookieRevert] = useState('');
      const [groupIdRevert, setGroupIdRevert] = useState('');
      const [ranksRevert, setRanksRevert] = useState([]);
      const [currentRankRevert, setCurrentRankRevert] = useState('');
      const [newRankRevert, setNewRankRevert] = useState('');
      const [logRevert, setLogRevert] = useState('Revert logs will appear here...');

      // Manual change states
      const [cookieManual, setCookieManual] = useState('');
      const [groupIdManual, setGroupIdManual] = useState('');
      const [ranksManual, setRanksManual] = useState([]);
      const [usersManual, setUsersManual] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedUser, setSelectedUser] = useState(null);
      const [newRankManual, setNewRankManual] = useState('');
      const [logManual, setLogManual] = useState('Manual change logs will appear here...');

      // Fetch ranks for revert mode
      async function fetchRanksRevert() {
        setLogRevert('‚è≥ Fetching ranks...');
        setRanksRevert([]);
        setCurrentRankRevert('');
        setNewRankRevert('');
        if (!groupIdRevert) {
          setLogRevert('‚ö†Ô∏è Please enter a Group ID first.');
          return;
        }
        try {
          const res = await fetch(`/roles?groupId=${groupIdRevert}`);
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Invalid data');
          setRanksRevert(data);
          setLogRevert('‚úÖ Ranks fetched!');
        } catch (e) {
          setLogRevert(`üíÄ Failed to fetch ranks: ${e.message}`);
        }
      }

      // Start revert action
      async function startRevert() {
        setLogRevert('‚è≥ Reverting ranks...');
        if (!cookieRevert || !groupIdRevert || !currentRankRevert || !newRankRevert) {
          setLogRevert('‚ö†Ô∏è Fill out all fields properly!');
          return;
        }
        try {
          const res = await fetch('/revert', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cookie: cookieRevert,
              groupId: parseInt(groupIdRevert),
              currentRankId: parseInt(currentRankRevert),
              newRankId: parseInt(newRankRevert),
            }),
          });
          const data = await res.json();
          if (data.success) {
            setLogRevert(`‚úÖ Reverted ${data.count} users!\n\n${(data.logs || []).join('\n')}`);
          } else {
            setLogRevert(`‚ùå Error: ${data.error}`);
          }
        } catch (e) {
          setLogRevert(`üí• Could not contact backend: ${e.message}`);
        }
      }

      // Fetch ranks and users for manual mode
      async function fetchUsersManual() {
        setLogManual('‚è≥ Fetching users and ranks...');
        setRanksManual([]);
        setUsersManual([]);
        setSelectedUser(null);
        setNewRankManual('');
        setSearchTerm('');
        if (!cookieManual || !groupIdManual) {
          setLogManual('‚ö†Ô∏è Enter cookie and Group ID!');
          return;
        }
        try {
          // Fetch ranks
          const resRanks = await fetch(`/roles?groupId=${groupIdManual}`);
          const ranksData = await resRanks.json();
          if (!Array.isArray(ranksData)) throw new Error('Failed to fetch ranks');
          setRanksManual(ranksData);

          // Fetch users
          const resUsers = await fetch(`/users?cookie=${encodeURIComponent(cookieManual)}&groupId=${groupIdManual}`);
          const usersData = await resUsers.json();
          if (!Array.isArray(usersData)) throw new Error('Failed to fetch users');
          setUsersManual(usersData);
          setLogManual(`‚úÖ Loaded ${usersData.length} users!`);
        } catch (e) {
          setLogManual(`üíÄ Error: ${e.message}`);
        }
      }

      // Filtered users for search
      const filteredUsers = usersManual.filter(u =>
        u.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
        u.userId.toString().includes(searchTerm)
      );

      // Change rank for single user
      async function changeSingleUserRank() {
        setLogManual('‚è≥ Changing user rank...');
        if (!cookieManual || !groupIdManual || !selectedUser || !newRankManual) {
          setLogManual('‚ö†Ô∏è Fill all fields and select a user!');
          return;
        }
        try {
          const res = await fetch('/changeUserRank', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              cookie: cookieManual,
              groupId: parseInt(groupIdManual),
              userId: selectedUser.userId,
              newRankId: parseInt(newRankManual),
            }),
          });
          const data = await res.json();
          if (data.success) {
            setLogManual(`‚úÖ Changed rank for ${selectedUser.username} (${selectedUser.userId})`);
          } else {
            setLogManual(`‚ùå Failed: ${data.error}`);
          }
        } catch (e) {
          setLogManual(`üí• Could not contact backend: ${e.message}`);
        }
      }

      return (
        <div className="bg-white rounded-2xl shadow-lg max-w-lg w-full p-8">
          <h1 className="text-2xl font-semibold mb-6 text-center">Roblox Rank Manager</h1>

          {/* Menu */}
          <div className="flex mb-6 gap-2 justify-center">
            <button
              onClick={() => setMode('revert')}
              className={`px-5 py-2 rounded-xl font-semibold shadow-md transition ${
                mode === 'revert'
                  ? 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white'
                  : 'bg-gray-100 text-gray-700'
              }`}
            >
              Revert Abuse
            </button>
            <button
              onClick={() => setMode('manual')}
              className={`px-5 py-2 rounded-xl font-semibold shadow-md transition ${
                mode === 'manual'
                  ? 'bg-gradient-to-r from-green-400 to-teal-500 text-white'
                  : 'bg-gray-100 text-gray-700'
              }`}
            >
              Change Single User Rank
            </button>
          </div>

          {/* Revert Abuse Section */}
          {mode === 'revert' && (
            <div className="space-y-4">
              {/* Security Cookie Input */}
              <div>
                <label className="block text-gray-700 font-medium mb-1">Security Cookie</label>
                <input
                  type="password"
                  placeholder=".ROBLOSECURITY cookie"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400"
                  value={cookieRevert}
                  onChange={(e) => setCookieRevert(e.target.value)}
                  autoComplete="off"
                />
              </div>
              {/* Group ID Input */}
              <div>
                <label className="block text-gray-700 font-medium mb-1">Group ID</label>
                <input
                  type="number"
                  placeholder="Group ID"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400"
                  value={groupIdRevert}
                  onChange={(e) => setGroupIdRevert(e.target.value)}
                />
              </div>
              {/* Fetch Ranks Button */}
              <button
                onClick={fetchRanksRevert}
                className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
              >
                Fetch Group Ranks
              </button>
              {/* Rank Selectors */}
              <div className="flex flex-col sm:flex-row sm:space-x-4">
                <div className="flex-1 mt-4 sm:mt-0">
                  <label className="block text-gray-700 font-medium mb-1">Current Rank</label>
                  <select
                    className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400"
                    value={currentRankRevert}
                    onChange={(e) => setCurrentRankRevert(e.target.value)}
                    disabled={ranksRevert.length === 0}
                  >
                    <option value="" disabled>
                      Select current rank
                    </option>
                    {ranksRevert.map((r) => (
                      <option key={r.id} value={r.id}>
                        ({r.rank}) {r.name}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="flex-1 mt-4 sm:mt-0">
                  <label className="block text-gray-700 font-medium mb-1">New Rank</label>
                  <select
                    className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400"
                    value={newRankRevert}
                    onChange={(e) => setNewRankRevert(e.target.value)}
                    disabled={ranksRevert.length === 0}
                  >
                    <option value="" disabled>
                      Select new rank
                    </option>
                    {ranksRevert.map((r) => (
                      <option key={r.id} value={r.id}>
                        ({r.rank}) {r.name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
              {/* Start Revert Button */}
              <button
                onClick={startRevert}
                className="w-full py-3 mt-4 bg-gradient-to-r from-green-400 to-teal-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
              >
                Start Revert
              </button>
              {/* Log Output Section */}
              <div className="mt-6 p-4 bg-gray-100 rounded-xl shadow-inner h-32 overflow-y-auto">
                <pre className="text-sm text-gray-700 whitespace-pre-wrap">{logRevert}</pre>
              </div>
            </div>
          )}

          {/* Manual Change Section */}
          {mode === 'manual' && (
            <div className="space-y-4">
              {/* Security Cookie Input */}
              <div>
                <label className="block text-gray-700 font-medium mb-1">Security Cookie</label>
                <input
                  type="password"
                  placeholder=".ROBLOSECURITY cookie"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400"
                  value={cookieManual}
                  onChange={(e) => setCookieManual(e.target.value)}
                  autoComplete="off"
                />
              </div>
              {/* Group ID Input */}
              <div>
                <label className="block text-gray-700 font-medium mb-1">Group ID</label>
                <input
                  type="number"
                  placeholder="Group ID"
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-400"
                  value={groupIdManual}
                  onChange={(e) => setGroupIdManual(e.target.value)}
                />
              </div>
              {/* Fetch Users & Ranks Button */}
              <button
                onClick={fetchUsersManual}
                className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
              >
                Fetch Users & Ranks
              </button>

              {/* Search User */}
              <input
                type="text"
                placeholder="Search users by username or ID"
                className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400 mt-4"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                disabled={usersManual.length === 0}
              />

              {/* Users List */}
              <div className="max-h-48 overflow-y-auto border border-gray-200 rounded-xl shadow-inner mt-2">
                {filteredUsers.length === 0 && usersManual.length > 0 && (
                  <p className="text-gray-500 p-3 text-center">No users found</p>
                )}
                <ul>
                  {filteredUsers.map((u) => (
                    <li
                      key={u.userId}
                      onClick={() => setSelectedUser(u)}
                      className={`cursor-pointer px-4 py-2 hover:bg-indigo-100 hover:text-indigo-900 ${
                        selectedUser?.userId === u.userId ? 'bg-indigo-200 text-indigo-900 font-semibold' : 'text-gray-700'
                      }`}
                    >
                      {u.username} ({u.userId})
                    </li>
                  ))}
                </ul>
              </div>

              {/* Rank Select for manual */}
              <div className="mt-4">
                <label className="block text-gray-700 font-medium mb-1">New Rank</label>
                <select
                  className="w-full p-3 border border-gray-200 rounded-xl shadow-sm focus:ring-2 focus:ring-indigo-400"
                  value={newRankManual}
                  onChange={(e) => setNewRankManual(e.target.value)}
                  disabled={ranksManual.length === 0}
                >
                  <option value="" disabled>
                    Select new rank
                  </option>
                  {ranksManual.map((r) => (
                    <option key={r.id} value={r.id}>
                      ({r.rank}) {r.name}
                    </option>
                  ))}
                </select>
              </div>

              {/* Change Rank Button */}
              <button
                onClick={changeSingleUserRank}
                className="w-full py-3 mt-4 bg-gradient-to-r from-green-400 to-teal-500 text-white font-medium rounded-xl shadow-md hover:opacity-90 transition"
                disabled={!selectedUser || !newRankManual}
              >
                Change User Rank
              </button>

              {/* Manual Log */}
              <div className="mt-6 p-4 bg-gray-100 rounded-xl shadow-inner h-32 overflow-y-auto">
                <pre className="text-sm text-gray-700 whitespace-pre-wrap">{logManual}</pre>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<RankManager />);
  </script>
</body>
</html>
